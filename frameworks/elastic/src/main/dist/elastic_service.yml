name: elastic
principal: "elastic-principal"
zookeeper: master.mesos:2181
api-port: {{PORT0}}
replacement-failure-policy:
  permanent-failure-timeout-ms: 100000
  min-replace-delay-ms: 100000
pods:
  master:
    count: 3
    user: {{FRAMEWORK_USER}}
    tasks:
      server:
        goal: RUNNING
        cpus: {{MASTER_NODE_CPUS}}
        memory: {{MASTER_NODE_MEM}}
        ports:
          - name: http
            port: {{MASTER_NODE_HTTP_PORT}}
          - name: transport
            port: {{MASTER_NODE_TRANSPORT_PORT}}
        volumes:
          - path: "container-path"
            type: {{MASTER_NODE_DISK_TYPE}}
            size: {{MASTER_NODE_DISK}}
        cmd: "env && ./scheduler/install_plugins.sh && ./scheduler/wait_dns.sh && exec ./elasticsearch-{{ELASTIC_VERSION}}/bin/elasticsearch"
        env:
          MASTER_NODE_TRANSPORT_PORT: {{MASTER_NODE_TRANSPORT_PORT}}
          HTTP_PORT: {{MASTER_NODE_HTTP_PORT}}
          TRANSPORT_PORT: {{MASTER_NODE_TRANSPORT_PORT}}
          MASTER_ENABLED: true
          DATA_ENABLED: false
          INGEST_ENABLED: false
          ES_JAVA_OPTS: "-Xms{{MASTER_NODE_HEAP_MB}}M -Xmx{{MASTER_NODE_HEAP_MB}}M"
          SERVICE_NAME: {{SERVICE_NAME}}
          ELASTIC_VERSION: {{ELASTIC_VERSION}}
          ELASTICSEARCH_PLUGINS: {{ELASTICSEARCH_PLUGINS}}
        uris:
          - "{{SCHEDULER_URI}}"
          - "https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-{{ELASTIC_VERSION}}.tar.gz"
          - "https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-{{ELASTIC_VERSION}}.zip"
          - "https://github.com/elastic/elasticsearch-support-diagnostics/releases/download/5.0/support-diagnostics-5.0-dist.zip"
        configurations:
          - template: "scheduler/elasticsearch.yml"
            dest: "elasticsearch-{{ELASTIC_VERSION}}/config/elasticsearch.yml"
        health-checks:
          check-up:
            cmd: "curl -I -s -f -u kibana:{{KIBANA_PASSWORD}} localhost:{{MASTER_NODE_HTTP_PORT}}"
            interval: 5
            grace-period: 300
            max-consecutive-failures: 3
            delay: 0
            timeout: 10
  data:
    count: {{DATA_NODE_COUNT}}
    user: {{FRAMEWORK_USER}}
    tasks:
      server:
        goal: RUNNING
        cpus: {{DATA_NODE_CPUS}}
        memory: {{DATA_NODE_MEM}}
        ports:
          - name: http
            port: {{DATA_NODE_HTTP_PORT}}
          - name: transport
            port: {{DATA_NODE_TRANSPORT_PORT}}
        volumes:
          - path: "container-path"
            type: {{DATA_NODE_DISK_TYPE}}
            size: {{DATA_NODE_DISK}}
        cmd: "env && ./scheduler/install_plugins.sh && ./scheduler/wait_dns.sh && exec ./elasticsearch-{{ELASTIC_VERSION}}/bin/elasticsearch"
        env:
          MASTER_NODE_TRANSPORT_PORT: {{MASTER_NODE_TRANSPORT_PORT}}
          HTTP_PORT: {{DATA_NODE_HTTP_PORT}}
          TRANSPORT_PORT: {{DATA_NODE_TRANSPORT_PORT}}
          MASTER_ENABLED: false
          DATA_ENABLED: true
          INGEST_ENABLED: false
          ES_JAVA_OPTS: "-Xms{{DATA_NODE_HEAP_MB}}M -Xmx{{DATA_NODE_HEAP_MB}}M"
          SERVICE_NAME: {{SERVICE_NAME}}
          ELASTIC_VERSION: {{ELASTIC_VERSION}}
          ELASTICSEARCH_PLUGINS: {{ELASTICSEARCH_PLUGINS}}
        uris:
          - "{{SCHEDULER_URI}}"
          - "https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-{{ELASTIC_VERSION}}.tar.gz"
          - "https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-{{ELASTIC_VERSION}}.zip"
          - "https://github.com/elastic/elasticsearch-support-diagnostics/releases/download/5.0/support-diagnostics-5.0-dist.zip"
        configurations:
          - template: "scheduler/elasticsearch.yml"
            dest: "elasticsearch-{{ELASTIC_VERSION}}/config/elasticsearch.yml"
        health-checks:
          check-up:
            cmd: "curl -I -s -f -u kibana:{{KIBANA_PASSWORD}} localhost:{{DATA_NODE_HTTP_PORT}}"
            interval: 5
            grace-period: 300
            max-consecutive-failures: 3
            delay: 0
            timeout: 10
  ingest:
    count: {{INGEST_NODE_COUNT}}
    user: {{FRAMEWORK_USER}}
    tasks:
      server:
        goal: RUNNING
        cpus: {{INGEST_NODE_CPUS}}
        memory: {{INGEST_NODE_MEM}}
        ports:
          - name: http
            port: {{INGEST_NODE_HTTP_PORT}}
          - name: transport
            port: {{INGEST_NODE_TRANSPORT_PORT}}
        volumes:
          - path: "container-path"
            type: {{INGEST_NODE_DISK_TYPE}}
            size: {{INGEST_NODE_DISK}}
        cmd: "env && ./scheduler/install_plugins.sh && ./scheduler/wait_dns.sh && exec ./elasticsearch-{{ELASTIC_VERSION}}/bin/elasticsearch"
        env:
          MASTER_NODE_TRANSPORT_PORT: {{MASTER_NODE_TRANSPORT_PORT}}
          HTTP_PORT: {{INGEST_NODE_HTTP_PORT}}
          TRANSPORT_PORT: {{INGEST_NODE_TRANSPORT_PORT}}
          MASTER_ENABLED: false
          DATA_ENABLED: false
          INGEST_ENABLED: true
          ES_JAVA_OPTS: "-Xms{{INGEST_NODE_HEAP_MB}}M -Xmx{{INGEST_NODE_HEAP_MB}}M"
          SERVICE_NAME: {{SERVICE_NAME}}
          ELASTIC_VERSION: {{ELASTIC_VERSION}}
          ELASTICSEARCH_PLUGINS: {{ELASTICSEARCH_PLUGINS}}
        uris:
          - "{{SCHEDULER_URI}}"
          - "https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-{{ELASTIC_VERSION}}.tar.gz"
          - "https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-{{ELASTIC_VERSION}}.zip"
          - "https://github.com/elastic/elasticsearch-support-diagnostics/releases/download/5.0/support-diagnostics-5.0-dist.zip"
        configurations:
          - template: "scheduler/elasticsearch.yml"
            dest: "elasticsearch-{{ELASTIC_VERSION}}/config/elasticsearch.yml"
        health-checks:
          check-up:
            cmd: "curl -I -s -f -u kibana:{{KIBANA_PASSWORD}} localhost:{{INGEST_NODE_HTTP_PORT}}"
            interval: 5
            grace-period: 300
            max-consecutive-failures: 3
            delay: 0
            timeout: 10
  coordinator:
    count: {{COORDINATOR_NODE_COUNT}}
    user: {{FRAMEWORK_USER}}
    tasks:
      server:
        goal: RUNNING
        cpus: {{COORDINATOR_NODE_CPUS}}
        memory: {{COORDINATOR_NODE_MEM}}
        ports:
          - name: http
            port: {{COORDINATOR_NODE_HTTP_PORT}}
          - name: transport
            port: {{COORDINATOR_NODE_TRANSPORT_PORT}}
        volumes:
          - path: "container-path"
            type: {{COORDINATOR_NODE_DISK_TYPE}}
            size: {{COORDINATOR_NODE_DISK}}
        cmd: "env && ./scheduler/install_plugins.sh && ./scheduler/wait_dns.sh && exec ./elasticsearch-{{ELASTIC_VERSION}}/bin/elasticsearch"
        env:
          MASTER_NODE_TRANSPORT_PORT: {{MASTER_NODE_TRANSPORT_PORT}}
          HTTP_PORT: {{COORDINATOR_NODE_HTTP_PORT}}
          TRANSPORT_PORT: {{COORDINATOR_NODE_TRANSPORT_PORT}}
          MASTER_ENABLED: false
          DATA_ENABLED: false
          INGEST_ENABLED: false
          ES_JAVA_OPTS: "-Xms{{COORDINATOR_NODE_HEAP_MB}}M -Xmx{{COORDINATOR_NODE_HEAP_MB}}M"
          SERVICE_NAME: {{SERVICE_NAME}}
          ELASTIC_VERSION: {{ELASTIC_VERSION}}
          ELASTICSEARCH_PLUGINS: {{ELASTICSEARCH_PLUGINS}}
        uris:
          - "{{SCHEDULER_URI}}"
          - "https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-{{ELASTIC_VERSION}}.tar.gz"
          - "https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-{{ELASTIC_VERSION}}.zip"
          - "https://github.com/elastic/elasticsearch-support-diagnostics/releases/download/5.0/support-diagnostics-5.0-dist.zip"
        configurations:
          - template: "scheduler/elasticsearch.yml"
            dest: "elasticsearch-{{ELASTIC_VERSION}}/config/elasticsearch.yml"
        health-checks:
          check-up:
            cmd: "curl -I -s -f -u kibana:{{KIBANA_PASSWORD}} localhost:{{COORDINATOR_NODE_HTTP_PORT}}"
            interval: 5
            grace-period: 300
            max-consecutive-failures: 3
            delay: 0
            timeout: 10
  kibana:
    count: {{KIBANA_COUNT}}
    user: {{FRAMEWORK_USER}}
    tasks:
      server:
        goal: RUNNING
        cpus: {{KIBANA_CPUS}}
        memory: {{KIBANA_MEM}}
        ports:
          - name: http
            port: {{KIBANA_PORT}}
        volumes:
          - path: "container-path"
            type: {{KIBANA_DISK_TYPE}}
            size: {{KIBANA_DISK}}
        cmd: "env && ./kibana-{{ELASTIC_VERSION}}-linux-x86_64/bin/kibana-plugin install file://$MESOS_SANDBOX/x-pack-{{ELASTIC_VERSION}}.zip && exec ./kibana-{{ELASTIC_VERSION}}-linux-x86_64/bin/kibana"
        env:
          SERVICE_NAME: {{SERVICE_NAME}}
          COORDINATOR_NODE_HTTP_PORT: {{COORDINATOR_NODE_HTTP_PORT}}
          KIBANA_PASSWORD: {{KIBANA_PASSWORD}}
          KIBANA_PORT: {{KIBANA_PORT}}
        uris:
          - "{{SCHEDULER_URI}}"
          - "https://artifacts.elastic.co/downloads/kibana/kibana-{{ELASTIC_VERSION}}-linux-x86_64.tar.gz"
          - "https://artifacts.elastic.co/downloads/packs/x-pack/x-pack-{{ELASTIC_VERSION}}.zip"
        configurations:
          - template: "scheduler/kibana.yml"
            dest: "kibana-{{ELASTIC_VERSION}}-linux-x86_64/config/kibana.yml"
        health-checks:
          check-up:
            cmd: "curl -I -s -f localhost:{{KIBANA_PORT}}/login"
            interval: 5
            grace-period: 600
            max-consecutive-failures: 3
            delay: 0
            timeout: 10
